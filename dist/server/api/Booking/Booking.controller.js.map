{"version":3,"sources":["api/Booking/Booking.controller.js"],"names":["req","res","startTimeHours","body","startTime","hours","startTimeMinutes","minutes","endTimeHours","endTime","endTimeMinutes","bookingProduct","totalTime","allProductFound","userId","decoded","user","fullName","first_name","last_name","bookingStartDateTime","bookingEndDateTime","momentDateTime","moment","tz","format","currentDate","Date","year","getFullYear","month","getMonth","date","getDate","NormalStartDateTime","NormalEndDateTime","totalPrice","not_acceptAble","all","map","singleBookingProduct","TeamMemberProductSingle","getTeamMemberProductList","product_id","teamMember_id","ProductItem","getProduct","price","approxTime","message","status","json","getTime","_LastBooking","getLastBookingOrder","visited","lastBookingDateTimeCalculation","bookingEndTime","addMinute","setMinutes","getMinutes","toUTCString","currentTimeWithZeroMinutes","getHours","diffTime","Math","abs","diffMinutes","ceil","BasketResponseGenerator","BasketGenerator","BookingAdd","id","customer_id","basket","basketResponse","teamWiseProductList","total","bookingDateTime","bookingStartTime","column","customerName","statusDateTime","save","then","InsertBooking","err","responseObject","productList","arrivalTime","_id","BookingItemsAdd","booking_id","team_id","active","InsertBookingItems","singleObject","publishMessage","data","orderPlace","error","console","log","index","bookingItem","productItem","productTeam","getTeam","object","push","teamMember","find","pushData","orderStatus","productId","listProductList","singleProduct","product","__v","description","sex","exec","_LastBookingOrder","findOneAndUpdate","$gte","$lte","$set","sort","teamId","teamList","singleTeam","team","teamMemberProductList","singleTeamMemberProduct","teamMemberProduct","startDayDateTime","startOf","endDayDateTime","endOf","NormalDateStartDateTime","NormalDateEndDateTime","runningOrder","runningLate","recentOrders","runningOrders","lateOrders","getBookingOrder","orderId","params","orderType","currentTime","updateResult","update","nModified","n","sodPublishMessage","_singleLateBooking","findOne","forEach","singleTeamWiseProductList","result","updateBookingOrder","teamMemberId","$elemMatch","getTeamMemberBookingOrder","require","_"],"mappings":"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","file":"Booking.controller.js","sourcesContent":["import Booking from './Booking.model';\r\nimport TeamMemberProduct from '../TeamMemberProduct/TeamMemberProduct.model';\r\nimport Product from '../Product/Product.model';\r\nimport BookingItems from '../BookingItems/BookingItems.model';\r\nimport Team from '../Team/Team.model';\r\n\r\nimport {jwtdata, errorJsonResponse, getGuid, setCache, getCache} from '../../config/commonHelper';\r\nimport {socketPublishMessage} from '../Socket/index';\r\n\r\nlet moment = require('moment-timezone');\r\nvar _ = require('lodash');\r\n\r\n// New Booking\r\nexport async function index(req, res) {\r\n    try {\r\n        let startTimeHours = req.body.startTime.hours;\r\n        let startTimeMinutes = req.body.startTime.minutes;\r\n        let endTimeHours = req.body.endTime.hours;\r\n        let endTimeMinutes = req.body.endTime.minutes;\r\n        let bookingProduct = req.body.bookingProduct;\r\n        let totalTime = 0;\r\n        let allProductFound = true;\r\n        let userId = req.decoded.user.userId;\r\n        let fullName = req.decoded.user.first_name + ' ' + req.decoded.user.last_name;\r\n        let bookingStartDateTime = '';\r\n        let bookingEndDateTime = '';\r\n        let momentDateTime = moment().tz('Asia/Kolkata').format();\r\n        let currentDate = new Date(momentDateTime);\r\n        let year = currentDate.getFullYear();\r\n        let month = currentDate.getMonth();\r\n        let date = currentDate.getDate();\r\n        let NormalStartDateTime = new Date(year, month, date, startTimeHours, startTimeMinutes, 0);\r\n        let NormalEndDateTime = new Date(year, month, date, endTimeHours, endTimeMinutes, 0);\r\n        let totalPrice = 0;\r\n        let not_acceptAble = false;\r\n\r\n        //Calculate the total time\r\n        await Promise.all(bookingProduct.map(async (singleBookingProduct) => {\r\n            let TeamMemberProductSingle = await getTeamMemberProductList(singleBookingProduct.product_id, singleBookingProduct.teamMember_id);\r\n\r\n            let ProductItem = await getProduct(singleBookingProduct.product_id);\r\n\r\n            if (ProductItem !== null) {\r\n                totalPrice += ProductItem.price;\r\n            } else {\r\n                allProductFound = false;\r\n            }\r\n\r\n            if (TeamMemberProductSingle !== null) {\r\n                totalTime += TeamMemberProductSingle.approxTime;\r\n            } else {\r\n                allProductFound = false;\r\n            }\r\n\r\n        }));\r\n\r\n        if (!allProductFound) {\r\n            let message = 'your order has been canceled, so please restart your application and place the booking again. we are sorry for this trouble.';\r\n            res.status(400)\r\n                .json(errorJsonResponse(message, message));\r\n        } else {\r\n\r\n            //check currentTime and booking selected time.\r\n            if (currentDate.getTime() < NormalEndDateTime.getTime()) {\r\n\r\n                let _LastBooking = await getLastBookingOrder(NormalStartDateTime, NormalEndDateTime);\r\n\r\n                if (_LastBooking !== null && _LastBooking.visited === false) {\r\n\r\n                    //Get Booking LastTime\r\n                    let lastBookingDateTimeCalculation = moment.tz(_LastBooking.bookingEndTime, 'Asia/Kolkata')\r\n                        .format();\r\n                    let addMinute = new Date(lastBookingDateTimeCalculation);\r\n                    if (currentDate.getTime() < addMinute.getTime()) {\r\n                        addMinute.setMinutes(addMinute.getMinutes() + totalTime);\r\n                        //set arrivalTime\r\n                        bookingStartDateTime = new Date(_LastBooking.bookingEndTime).toUTCString();\r\n                        //set order finish time.\r\n                        bookingEndDateTime = addMinute.toUTCString();\r\n                    } else {\r\n                        let currentTimeWithZeroMinutes = new Date(year, month, date, currentDate.getHours(), currentDate.getMinutes(), 0);\r\n                        bookingStartDateTime = currentTimeWithZeroMinutes.toUTCString();\r\n                        addMinute = currentTimeWithZeroMinutes;\r\n                        addMinute.setMinutes(currentTimeWithZeroMinutes.getMinutes() + totalTime);\r\n                        bookingEndDateTime = addMinute.toUTCString();\r\n                    }\r\n\r\n                    const diffTime = Math.abs(NormalEndDateTime.getTime() - addMinute.getTime());\r\n                    const diffMinutes = Math.ceil(diffTime / (1000 * 60));\r\n                    if (!((NormalEndDateTime.getTime() >= addMinute.getTime()) && diffMinutes >= 0)) {\r\n                        not_acceptAble = true;\r\n                    }\r\n\r\n                } else {\r\n\r\n                    //Never execute this part.\r\n                    //first order set stating time and add minutes and generate end time\r\n                    if (currentDate.getTime() < NormalStartDateTime.getTime()) {\r\n                        bookingStartDateTime = NormalStartDateTime.toUTCString();\r\n                        let addMinute = NormalStartDateTime;\r\n                        addMinute.setMinutes(NormalStartDateTime.getMinutes() + totalTime);\r\n                        bookingEndDateTime = addMinute.toUTCString();\r\n                    } else {\r\n                        bookingStartDateTime = currentDate.toUTCString();\r\n                        let addMinute = currentDate;\r\n                        addMinute.setMinutes(currentDate.getMinutes() + totalTime);\r\n                        bookingEndDateTime = addMinute.toUTCString();\r\n                    }\r\n                }\r\n\r\n                if (!not_acceptAble) {\r\n                    //Generate the Basket Response.\r\n                    let BasketResponseGenerator = await BasketGenerator(bookingProduct);\r\n\r\n\r\n                    let BookingAdd = new Booking({\r\n                        id: getGuid(),\r\n                        customer_id: userId,\r\n                        basket: BasketResponseGenerator.basketResponse,\r\n                        teamWiseProductList: BasketResponseGenerator.teamWiseProductList,\r\n                        total: totalPrice,\r\n                        bookingDateTime: currentDate.toUTCString(),\r\n                        bookingStartTime: bookingStartDateTime,\r\n                        bookingEndTime: bookingEndDateTime,\r\n                        status: 'waiting',\r\n                        column: 'recent orders',\r\n                        customerName: fullName,\r\n                        visited: false,\r\n                        statusDateTime: currentDate.toUTCString()\r\n                    });\r\n                    BookingAdd.save()\r\n                        .then(async function (InsertBooking, err) {\r\n                            if (!err) {\r\n                                if (InsertBooking) {\r\n                                    let responseObject = {\r\n                                        id: InsertBooking.id,\r\n                                        customer_id: InsertBooking.customer_id,\r\n                                        customerName: fullName,\r\n                                        productList: InsertBooking.basket,\r\n                                        total: InsertBooking.total,\r\n                                        bookingDateTime: moment.tz(InsertBooking.bookingDateTime, 'Asia/Kolkata')\r\n                                            .format(),\r\n                                        arrivalTime: moment.tz(InsertBooking.bookingStartTime, 'Asia/Kolkata')\r\n                                            .format(),\r\n                                        bookingEndTime: moment.tz(InsertBooking.bookingEndTime, 'Asia/Kolkata')\r\n                                            .format(),\r\n                                        status: InsertBooking.status,\r\n                                        column: InsertBooking.column,\r\n                                        statusDateTime: moment.tz(InsertBooking.statusDateTime, 'Asia/Kolkata')\r\n                                            .format(),\r\n                                        _id: InsertBooking._id\r\n                                    };\r\n\r\n                                    //ProductItemStore into BookingItem Collection.\r\n                                    await Promise.all(bookingProduct.map(async (singleBookingProduct) => {\r\n                                        let BookingItemsAdd = new BookingItems({\r\n                                            id: getGuid(),\r\n                                            booking_id: InsertBooking.id,\r\n                                            product_id: singleBookingProduct.product_id,\r\n                                            team_id: singleBookingProduct.teamMember_id,\r\n                                            active: true,\r\n                                        });\r\n                                        BookingItemsAdd.save()\r\n                                            .then(async function (InsertBookingItems, err) {\r\n                                                if (!err) {\r\n                                                    if (!InsertBookingItems) {\r\n                                                        res.status(400)\r\n                                                            .json(errorJsonResponse('Error in db BookingItems response', 'Error in db BookingItems response'));\r\n                                                    }\r\n                                                } else {\r\n                                                    res.status(400)\r\n                                                        .json(errorJsonResponse(err, 'Contact to your Developer'));\r\n                                                }\r\n                                            });\r\n                                    }));\r\n\r\n                                    //ToDO send to TeamMember\r\n                                    BasketResponseGenerator.teamWiseProductList.map(async (singleObject) => {\r\n                                        let publishMessage = {\r\n                                            message: 'new order',\r\n                                            data: {\r\n                                                _id: InsertBooking._id,\r\n                                                id: InsertBooking.id,\r\n                                                customer_id: InsertBooking.customer_id,\r\n                                                customerName: fullName,\r\n                                                basket: singleObject.productList,\r\n                                                total: InsertBooking.total,\r\n                                                bookingDateTime: InsertBooking.bookingDateTime,\r\n                                                bookingStartTime: InsertBooking.bookingStartTime,\r\n                                                bookingEndTime: InsertBooking.bookingEndTime,\r\n                                                status: InsertBooking.status,\r\n                                                column: InsertBooking.column,\r\n                                                statusDateTime: InsertBooking.statusDateTime,\r\n                                            }\r\n                                        };\r\n                                        await socketPublishMessage(singleObject.id, publishMessage);\r\n                                    });\r\n\r\n                                    //ToDO send to SOD\r\n                                    let publishMessage = {\r\n                                        message: 'new order',\r\n                                        data: {\r\n                                            _id: InsertBooking._id,\r\n                                            id: InsertBooking.id,\r\n                                            customer_id: InsertBooking.customer_id,\r\n                                            customerName: fullName,\r\n                                            basket: InsertBooking.basket,\r\n                                            //teamWiseProductList: BasketResponseGenerator.teamWiseProductList,\r\n                                            total: InsertBooking.total,\r\n                                            bookingDateTime: InsertBooking.bookingDateTime,\r\n                                            bookingStartTime: InsertBooking.bookingStartTime,\r\n                                            bookingEndTime: InsertBooking.bookingEndTime,\r\n                                            status: InsertBooking.status,\r\n                                            column: InsertBooking.column,\r\n                                            statusDateTime: InsertBooking.statusDateTime,\r\n                                        }\r\n                                    };\r\n\r\n                                    await socketPublishMessage('SOD', publishMessage);\r\n\r\n                                    res.status(200)\r\n                                        .json({\r\n                                            totalTime,\r\n                                            orderPlace: responseObject\r\n                                        });\r\n\r\n                                } else {\r\n                                    res.status(400)\r\n                                        .json(errorJsonResponse('Error in db response', 'Error in db response'));\r\n                                }\r\n                            } else {\r\n                                res.status(400)\r\n                                    .json(errorJsonResponse(err, 'Contact to your Developer'));\r\n                            }\r\n                        });\r\n                } else {\r\n                    res.status(406)\r\n                        .json(errorJsonResponse('your order is not Accepted, please select another time slot and book your order', 'your order is not Accepted, please select another time slot and book your order'));\r\n                }\r\n            } else {\r\n                let message = 'you have selected wrong time, please choose the valid time slot.';\r\n                res.status(400)\r\n                    .json(errorJsonResponse(message, message));\r\n            }\r\n        }\r\n    } catch (error) {\r\n        console.log(error);\r\n    }\r\n}\r\n\r\nasync function BasketGenerator(bookingProduct) {\r\n    try {\r\n\r\n        let basketResponse = [];\r\n        let teamWiseProductList = [];\r\n\r\n        await Promise.all(bookingProduct.map(async (bookingItem) => {\r\n\r\n            let productItem = await getProduct(bookingItem.product_id);\r\n            let productTeam = await getTeam(bookingItem.teamMember_id);\r\n            let object = {\r\n                productItem,\r\n                productTeam\r\n            };\r\n            basketResponse.push(object);\r\n\r\n            let teamMember = teamWiseProductList.find((teamMember) => teamMember.id === productTeam.id);\r\n            if (!teamMember) {\r\n                let pushData = {\r\n                    id: productTeam.id,\r\n                    productList: [],\r\n                    orderStatus: false,\r\n                };\r\n                pushData.productList.push(productItem);\r\n                teamWiseProductList.push(pushData);\r\n            } else {\r\n                teamMember.productList.push(productItem);\r\n            }\r\n        }));\r\n\r\n        return {basketResponse, teamWiseProductList};\r\n\r\n    } catch (error) {\r\n        console.log(error);\r\n        return error;\r\n    }\r\n}\r\n\r\nasync function getProduct(productId, index = 0) {\r\n    let listProductList = getCache('productList');\r\n    if (listProductList !== null) {\r\n        let singleProduct = listProductList.find((product) => product.id === productId);\r\n        if (singleProduct) {\r\n            return singleProduct;\r\n        } else {\r\n            if (index === 0) {\r\n                return getProduct(productId, 1);\r\n            } else {\r\n                return null;\r\n            }\r\n        }\r\n    } else {\r\n        listProductList = await Product.find({}, {_id: 0, __v: 0, description: 0, date: 0, sex: 0})\r\n            .exec();\r\n        setCache('productList', listProductList);\r\n        return getProduct(productId, 1);\r\n    }\r\n}\r\n\r\nasync function getLastBookingOrder(NormalStartDateTime, NormalEndDateTime) {\r\n\r\n    let _LastBookingOrder = await Booking.findOneAndUpdate({\r\n        visited: false,\r\n        bookingEndTime: {$gte: NormalStartDateTime.toUTCString(), $lte: NormalEndDateTime.toUTCString()}\r\n    }, {$set: {visited: true}}, {sort: {bookingEndTime: -1}}).exec();\r\n\r\n    if (_LastBookingOrder === null)\r\n    //Todo should not be received null value\r\n        return getLastBookingOrder(NormalStartDateTime, NormalEndDateTime);\r\n    else if (_LastBookingOrder.visited === true)\r\n        return getLastBookingOrder(NormalStartDateTime, NormalEndDateTime);\r\n    else\r\n        return _LastBookingOrder;\r\n}\r\n\r\nasync function getTeam(teamId, index = 0) {\r\n    let teamList = getCache('teamList');\r\n    if (teamList !== null) {\r\n        let singleTeam = teamList.find((team) => team.id === teamId);\r\n        if (singleTeam) {\r\n            return singleTeam;\r\n        } else {\r\n            if (index === 0) {\r\n                return getTeam(teamId, 1);\r\n            } else {\r\n                return null;\r\n            }\r\n        }\r\n    } else {\r\n        teamList = await Team.find({}, {_id: 0, __v: 0, description: 0})\r\n            .exec();\r\n        setCache('teamList', teamList);\r\n        return getTeam(teamId, 1);\r\n    }\r\n}\r\n\r\nasync function getTeamMemberProductList(product_id, teamMember_id, index = 0) {\r\n    let teamMemberProductList = getCache('teamMemberProductList');\r\n    if (teamMemberProductList !== null) {\r\n        let singleTeamMemberProduct = teamMemberProductList.find((teamMemberProduct) => teamMemberProduct.product_id === product_id && teamMember_id === teamMember_id);\r\n        if (singleTeamMemberProduct) {\r\n            return singleTeamMemberProduct;\r\n        } else {\r\n            if (index === 0) {\r\n                return getTeamMemberProductList(product_id, teamMember_id, 1);\r\n            } else {\r\n                return null;\r\n            }\r\n        }\r\n    } else {\r\n        teamMemberProductList = await TeamMemberProduct.find()\r\n            .exec();\r\n        setCache('teamMemberProductList', teamMemberProductList);\r\n        return getTeamMemberProductList(product_id, teamMember_id, 1);\r\n    }\r\n}\r\n\r\nexport async function getBookingOrder(req, res) {\r\n    try {\r\n\r\n        let startDayDateTime = moment()\r\n            .tz('Asia/Kolkata')\r\n            .startOf('day')\r\n            .format();\r\n        let endDayDateTime = moment()\r\n            .tz('Asia/Kolkata')\r\n            .endOf('day')\r\n            .format();\r\n        let NormalDateStartDateTime = new Date(startDayDateTime);\r\n        let NormalDateEndDateTime = new Date(endDayDateTime);\r\n\r\n        let responseObject = {\r\n            runningOrder: [],\r\n            runningLate: [],\r\n            recentOrders: []\r\n        };\r\n\r\n        let recentOrders = await Booking.find({\r\n            status: 'waiting',\r\n            bookingEndTime: {\r\n                $gte: NormalDateStartDateTime.toUTCString(),\r\n                $lte: NormalDateEndDateTime.toUTCString()\r\n            }\r\n        }, {teamWiseProductList: 0})\r\n            .sort({bookingStartTime: 1})\r\n            .exec();\r\n\r\n        let runningOrders = await Booking.find({\r\n            status: 'process',\r\n            bookingEndTime: {\r\n                $gte: NormalDateStartDateTime.toUTCString(),\r\n                $lte: NormalDateEndDateTime.toUTCString()\r\n            }\r\n        }, {teamWiseProductList: 0})\r\n            .sort({bookingStartTime: 1})\r\n            .exec();\r\n\r\n        let lateOrders = await Booking.find({\r\n            status: 'late',\r\n            bookingEndTime: {\r\n                $gte: NormalDateStartDateTime.toUTCString(),\r\n                $lte: NormalDateEndDateTime.toUTCString()\r\n            }\r\n        }, {teamWiseProductList: 0})\r\n            .sort({bookingStartTime: 1})\r\n            .exec();\r\n\r\n        responseObject.recentOrders = recentOrders;\r\n        responseObject.runningLate = lateOrders;\r\n        responseObject.runningOrder = runningOrders;\r\n\r\n        res.status(200)\r\n            .json(responseObject);\r\n\r\n    } catch (error) {\r\n        console.log(error);\r\n    }\r\n}\r\n\r\nexport async function updateBookingOrder(req, res) {\r\n    try {\r\n\r\n        let orderId = req.params.orderId;\r\n        let orderType = req.body.orderType;\r\n\r\n        let status = 'process';\r\n        let column = 'running';\r\n        let message = 'running';\r\n\r\n        if (orderType === 'finish') {\r\n            status = 'finish';\r\n            column = 'finish';\r\n            message = 'finish';\r\n        }\r\n\r\n        let currentTime = moment.tz('Asia/Kolkata').format();\r\n        let currentDate = new Date(currentTime);\r\n        let statusDateTime = currentDate.toUTCString();\r\n\r\n        let updateResult = await Booking.update({id: orderId}, {\r\n            status: status,\r\n            column: column,\r\n            statusDateTime: statusDateTime\r\n        })\r\n            .exec();\r\n\r\n        if (updateResult) {\r\n            if (updateResult.nModified === 1 || updateResult.n === 1) {\r\n\r\n                let sodPublishMessage = {\r\n                    message: message,\r\n                    data: {\r\n                        id: orderId,\r\n                        orderType: orderType,\r\n                        status: status,\r\n                        column: column,\r\n                        statusDateTime: statusDateTime\r\n                    }\r\n                };\r\n                await socketPublishMessage('SOD', sodPublishMessage);\r\n\r\n                let _singleLateBooking = await Booking.findOne({id: orderId}).exec();\r\n\r\n                //TODO send to teamMember\r\n                _singleLateBooking.teamWiseProductList.forEach(async (singleTeamWiseProductList) => {\r\n                    await socketPublishMessage(singleTeamWiseProductList.id, sodPublishMessage);\r\n                });\r\n\r\n                res.status(200)\r\n                    .json({result: true});\r\n\r\n            } else {\r\n                console.log(updateResult);\r\n            }\r\n        } else {\r\n            console.log('contact to developer');\r\n        }\r\n\r\n    } catch (error) {\r\n        console.log(error);\r\n    }\r\n}\r\n\r\nexport async function getTeamMemberBookingOrder(req, res) {\r\n    try {\r\n\r\n        let teamMemberId = req.params.teamMemberId;\r\n        let startDayDateTime = moment().tz('Asia/Kolkata').startOf('day').format();\r\n        let endDayDateTime = moment().tz('Asia/Kolkata').endOf('day').format();\r\n        let NormalDateStartDateTime = new Date(startDayDateTime);\r\n        let NormalDateEndDateTime = new Date(endDayDateTime);\r\n\r\n        let responseObject = {\r\n            runningOrder: [],\r\n            runningLate: [],\r\n            recentOrders: []\r\n        };\r\n\r\n        let recentOrders = await Booking.find({\r\n            status: 'waiting',\r\n            bookingEndTime: {\r\n                $gte: NormalDateStartDateTime.toUTCString(),\r\n                $lte: NormalDateEndDateTime.toUTCString()\r\n            },\r\n            teamWiseProductList: {\r\n                $elemMatch: {\r\n                    id: teamMemberId,\r\n                    orderStatus: false\r\n                }\r\n            }\r\n        }).sort({bookingStartTime: 1}).exec();\r\n\r\n        let runningOrders = await Booking.find({\r\n            status: 'process',\r\n            bookingEndTime: {\r\n                $gte: NormalDateStartDateTime.toUTCString(),\r\n                $lte: NormalDateEndDateTime.toUTCString()\r\n            },\r\n            teamWiseProductList: {\r\n                $elemMatch: {\r\n                    id: teamMemberId,\r\n                    orderStatus: false\r\n                }\r\n            }\r\n        }).sort({bookingStartTime: 1}).exec();\r\n\r\n        let lateOrders = await Booking.find({\r\n            status: 'late',\r\n            bookingEndTime: {\r\n                $gte: NormalDateStartDateTime.toUTCString(),\r\n                $lte: NormalDateEndDateTime.toUTCString()\r\n            },\r\n            teamWiseProductList: {\r\n                $elemMatch: {\r\n                    id: teamMemberId,\r\n                    orderStatus: false\r\n                }\r\n            }\r\n        }).sort({bookingStartTime: 1}).exec();\r\n\r\n        responseObject.recentOrders = recentOrders;\r\n        responseObject.runningLate = lateOrders;\r\n        responseObject.runningOrder = runningOrders;\r\n\r\n        res.status(200)\r\n            .json(responseObject);\r\n\r\n\r\n    } catch (error) {\r\n        console.log(error);\r\n    }\r\n}\r\n"]}